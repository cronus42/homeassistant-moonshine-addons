name: Create GitHub Release

on:
  push:
    tags:
      - "v*"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build release notes
        run: |
          TAG="${GITHUB_REF_NAME}"
          PLAIN_TAG="${TAG#v}"
          IMAGE_BASE="ghcr.io/${{ github.repository_owner }}/wyoming-moonshine-addon"

          cat > RELEASE_BODY.md <<EOF
          ## Images

          Built and published Home Assistant add-on images for this release:

          - \`${IMAGE_BASE}-amd64:${TAG}\`
          - \`${IMAGE_BASE}-amd64:${PLAIN_TAG}\`
          - \`${IMAGE_BASE}-aarch64:${TAG}\`
          - \`${IMAGE_BASE}-aarch64:${PLAIN_TAG}\`

          These tags correspond to the add-on version \`${PLAIN_TAG}\` defined in 
          \`wyoming-moonshine/config.yaml\` and can be used by Home Assistant Supervisor
          when pulling the add-on image.

          ## Notes

          - Add-on repository: ${{ github.repositoryUrl }}
          - Add-on manifest: \`wyoming-moonshine/config.yaml\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Wyoming Moonshine add-ons ${{ github.ref_name }}
          body_path: RELEASE_BODY.md
          draft: false
          prerelease: false
